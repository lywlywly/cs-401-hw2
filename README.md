# Project 2: DevOps and Cloud Computing

## Introduction

In this project, I developed a machine learning-based playlist recommender system using Frequent Itemset Mining. The system includes a REST server and client, and it is deployed using Kubernetes.

## Part 1: Software Components

### 1. Playlist Rules Generator

The ML Processor module is responsible for running a Frequent Itemset Mining algorithm to generate rules for song recommendations. It downloads the dataset from the `DATASET_URL` environment variable and saves the generated rules in the directory specified by the `DATA_DIR` environment variable.

### 2. REST API Server

The REST API Server exposes a POST endpoint at `/api/recommend` on port 52003. It accepts a request containing a list of songs and responds with song recommendations based on the input.

Request:

```json
{
    "songs": [
        "HUMBLE.",
        "No Role Modelz"
    ]
}
```

Response:

```jsonc
{
    "songs": [
        "goosebumps",
        "Bad and Boujee (feat. Lil Uzi Vert)",
        "Broccoli (feat. Lil Yachty)",
    ],
    "model_date": "2024-02-21 12:06:07.238686",
    "version": "1.0"
}
```

The server reads the rules generated by the ML Processor from the directory specified by the `DATA_DIR` environment variable and provides responses with recommended songs.

### 3. REST API Client

```sh
$ python3 client.py -h
usage: client.py [-h] -H HOST -p PORT -i INPUT [INPUT ...] [-c]

Playlist recommendation.

optional arguments:
  -h, --help            show this help message and exit
  -H HOST, --host HOST  Host IP address.
  -p PORT, --port PORT  Port number.
  -i INPUT [INPUT ...], --input INPUT [INPUT ...]
                        Input tracks.
  -c, --continuous      Continuous send requests, save result in `log.log`.
```

Example usage:

```sh
$ python3 client.py -H 10.109.19.3 -p 52002 -i DNA.
>>> Code version: 1.0
>>> Model time: 2024-02-25 14:42:09.165802
>>> Dataset: 2023_spotify_ds1.csv
>>> Recommended songs: ['Mask Off', 'XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'HUMBLE.']
```

The client script also includes a `-c` flag for continuous posting. This flag is used to generate test traffic for part 3 of the process. When enabled, the script sends requests to the server approximately every 0.1 second. The responses from the server are logged in a file called `log.log`, along with their corresponding timestamps.

## Part2: Continuous Integration and Continuous Delivery

### 1. Docker Containers

Two Docker containers are created:

- ML container: This container runs the ML Processor module to generate recommendation rules and save them. It mounts the a volume and saves generated rules to the directory specified by `DATA_DIR` environment.
- REST server container: This container runs the REST API Server. It reads the rules generated by the ML Processor from the same volume and serves HTTP requests. It listens on port 9999 inside the container and maps it to port 52002 on the host.

The containers can be run using the following commands, assuming the `hw2` volume is already created:

```shell
docker run --mount type=volume,src=hw2,target=/data -e DATA_DIR=/data ml
docker run -p 127.0.0.1:52002:9999 --mount type=volume,src=hw2,target=/data -e DATA_DIR=/data server
```

### 2. Kubernetes Deployment and Service

The Kubernetes configurations are defined in the `k8s.yml` file. The configurations include:

- A persistent volume claim (PVC) to provide storage for the ML Processor and REST API Server containers.
- A deployment that runs the ML Processor container and mounts the PVC at `/data`.
- A deployment that runs the REST API Server container and mounts the PVC at `/data`. It listens on port 9999 inside the container.
- A service that exposes the REST API Server container's port 9999 on port 52003 of the VM.

### 3. Configure Automatic Deployment in ArgoCD

I use the ArgoCD configuration file generated from the web UI, as outlined below.

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: hw2-lw337-app
spec:
  destination:
    name: ''
    namespace: lw337
    server: 'https://kubernetes.default.svc'
  source:
    path: hw2/
    repoURL: 'https://github.com/lywlywly/cs-401-hw2'
    targetRevision: HEAD
  sources: []
  project: lw337-project
  syncPolicy:
    automated:
      prune: true
      selfHeal: false
    syncOptions: []
```

Kubernetes restricts modifying a Pod's variables once it has been created. Consequently, if you need to switch to a different dataset URL after deploying the application, you'll need to explore alternative solutions. One workaround, as mentioned in the assignment specification, involves modifying the pod name in the Kubernetes configuration's metadata.

To ensure that ArgoCD removes obsolete resources not defined in the configuration file, we should set the `prune` option to `true` in the ArgoCD configuration. This way, when the pod name changes in the Kubernetes configuration's metadata, ArgoCD will appropriately clean up outdated resources.

## Part 3: Exercise and Evaluate Continuous Delivery

### 1. Update the number of replicas in the Kubernetes deployment

I modified the `replicas` value for both the ML rule generator and rest server from 2 to 3 in the `k8s-tasks.yml` file. After making this change, I pushed it to the Git repository.

In the ArgoCD web UI, the following information is displayed:

```
Revision:
5d5b1b7
Authored by
Luyao Wang <lywlywly@gmail.com>
13 minutes ago (Sun Feb 25 2024 22:36:07 GMT+0800)
change replicas to 3

Deployed At:
12 minutes ago (Sun Feb 25 2024 22:37:17 GMT+0800)

Time to deploy:
00:01 min
```

It took approximately 1 minute for ArgoCD to synchronize the changes from the Git repository and deploy the updated configuration.

```
2024-02-25 09:36:34,549 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 09:36:34,551 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 178
2024-02-25 09:36:34,551 | INFO | Code version: 1.0
2024-02-25 09:36:34,552 | INFO | Model time: 2024-02-25 14:47:08.878004
2024-02-25 09:36:34,552 | INFO | Dataset: 2023_spotify_ds1.csv
2024-02-25 09:36:34,552 | INFO | Recommended songs: ['XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'HUMBLE.', 'Mask Off']
2024-02-25 09:36:34,654 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 09:36:34,659 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 178
2024-02-25 09:36:34,659 | INFO | Code version: 1.0
2024-02-25 09:36:34,659 | INFO | Model time: 2024-02-25 14:47:08.878004
2024-02-25 09:36:34,659 | INFO | Dataset: 2023_spotify_ds1.csv
2024-02-25 09:36:34,660 | INFO | Recommended songs: ['XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'Mask Off', 'HUMBLE.']
```

Upon reviewing the contents of the log.log file, I verified that there were no instances of downtime recorded.

### Update the dataset of playlists used to generate the recommendation model

I modified the `DATASET_URL` environment variable in `k8s-tasks`.yml from "<https://homepages.dcc.ufmg.br/~cunha/hosted/cloudcomp-2023s2-datasets/2023_spotify_ds1.csv>" to "<https://homepages.dcc.ufmg.br/~cunha/hosted/cloudcomp-2023s2-datasets/2023_spotify_ds2.csv>". I also changed the pod name in the metadata section of the deployment configuration to `ml-deployment-lw337-03`.

Immediately after pushing the changes to GitHub, I initiated the continuous posting script. This time it took approximately 2 minutes for ArgoCD to synchronize with the Git repository.

I committed and pushed the change at Sun Feb 25 2024 23:01:49 GMT+0800, and ArgoCD deployed the updated configuration at Sun Feb 25 2024 23:03:40 GMT+0800. Upon inspecting the log file, I discovered that the new dataset was being utilized for inference starting from 2024-02-25 10:04:05,556 (server GMT-5 timezone).

```
2024-02-25 10:04:05,333 | INFO | Code version: 1.0
2024-02-25 10:04:05,333 | INFO | Model time: 2024-02-25 15:03:57.152193
2024-02-25 10:04:05,333 | INFO | Dataset: 2023_spotify_ds1.csv
2024-02-25 10:04:05,333 | INFO | Recommended songs: ['Mask Off', 'XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'HUMBLE.']
2024-02-25 10:04:05,436 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:04:05,438 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 178
2024-02-25 10:04:05,440 | INFO | Code version: 1.0
2024-02-25 10:04:05,441 | INFO | Model time: 2024-02-25 15:03:57.152193
2024-02-25 10:04:05,441 | INFO | Dataset: 2023_spotify_ds1.csv
2024-02-25 10:04:05,441 | INFO | Recommended songs: ['XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'HUMBLE.', 'Mask Off']
2024-02-25 10:04:05,550 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:04:05,555 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:04:05,556 | INFO | Code version: 1.0
2024-02-25 10:04:05,556 | INFO | Model time: 2024-02-25 15:04:05.475977
2024-02-25 10:04:05,557 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:04:05,557 | INFO | Recommended songs: ['Bad and Boujee (feat. Lil Uzi Vert)', 'Mask Off', 'XO TOUR Llif3', 'Bounce Back', 'goosebumps', 'Congratulations', 'T-Shirt', 'HUMBLE.']
2024-02-25 10:04:05,660 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:04:05,663 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:04:05,665 | INFO | Code version: 1.0
2024-02-25 10:04:05,665 | INFO | Model time: 2024-02-25 15:04:05.475977
2024-02-25 10:04:05,665 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:04:05,665 | INFO | Recommended songs: ['Bad and Boujee (feat. Lil Uzi Vert)', 'Mask Off', 'XO TOUR Llif3', 'Bounce Back', 'goosebumps', 'Congratulations', 'T-Shirt', 'HUMBLE.']
2024-02-25 10:04:05,766 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:04:05,770 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
```

As indicated in the log file, there was a brief pause of approximately half a second before the dataset switched from 1 to 2. Consequently, the downtime for updating the dataset amounted to approximately 0.5 seconds. After pushing the change, it took approximately 3 minutes and 16 seconds for the client to receive a response from the new dataset. It is worth noting that there was no significant offline time, with only a brief 0.5-second interruption during the dataset switch.

### Update rest server container images version

I modified the code version number of the rest server, changing it from 2.2 to 2.3. Additionally, I updated the container version from 0.4 to 0.5 to reflect this change.

```
2024-02-25 10:37:14,923 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:14,924 | ERROR | Request failed: HTTPConnectionPool(host='10.109.19.3', port=52002): Max retries exceeded with url: /api/recommend (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7fe6a59b1d30>: Failed to establish a new connection: [Errno 111] Connection refused'))
2024-02-25 10:37:14,925 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:14,927 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:14,927 | INFO | Response: <Response [200]>
2024-02-25 10:37:14,927 | INFO | Code version: 2.2
2024-02-25 10:37:14,927 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:14,927 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:14,927 | INFO | Recommended songs: ['Mask Off', 'HUMBLE.', 'Bad and Boujee (feat. Lil Uzi Vert)', 'goosebumps', 'T-Shirt', 'XO TOUR Llif3', 'Congratulations', 'Bounce Back']
2024-02-25 10:37:15,028 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,030 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,031 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,031 | INFO | Code version: 2.2
2024-02-25 10:37:15,031 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,031 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,031 | INFO | Recommended songs: ['Mask Off', 'HUMBLE.', 'Bad and Boujee (feat. Lil Uzi Vert)', 'goosebumps', 'T-Shirt', 'XO TOUR Llif3', 'Congratulations', 'Bounce Back']
2024-02-25 10:37:15,132 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,135 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,135 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,135 | INFO | Code version: 2.3
2024-02-25 10:37:15,135 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,135 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,135 | INFO | Recommended songs: ['T-Shirt', 'goosebumps', 'HUMBLE.', 'XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'Mask Off', 'Bounce Back', 'Congratulations']
2024-02-25 10:37:15,237 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,239 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,239 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,239 | INFO | Code version: 2.2
2024-02-25 10:37:15,239 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,239 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,239 | INFO | Recommended songs: ['Mask Off', 'HUMBLE.', 'Bad and Boujee (feat. Lil Uzi Vert)', 'goosebumps', 'T-Shirt', 'XO TOUR Llif3', 'Congratulations', 'Bounce Back']
2024-02-25 10:37:15,340 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,344 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,344 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,344 | INFO | Code version: 2.3
2024-02-25 10:37:15,344 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,344 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,344 | INFO | Recommended songs: ['Bounce Back', 'Bad and Boujee (feat. Lil Uzi Vert)', 'Congratulations', 'XO TOUR Llif3', 'HUMBLE.', 'Mask Off', 'T-Shirt', 'goosebumps']
2024-02-25 10:37:15,445 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,448 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,448 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,448 | INFO | Code version: 2.2
2024-02-25 10:37:15,448 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,448 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,449 | INFO | Recommended songs: ['Mask Off', 'HUMBLE.', 'Bad and Boujee (feat. Lil Uzi Vert)', 'goosebumps', 'T-Shirt', 'XO TOUR Llif3', 'Congratulations', 'Bounce Back']
2024-02-25 10:37:15,550 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,552 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,553 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,553 | INFO | Code version: 2.3
2024-02-25 10:37:15,553 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,553 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,553 | INFO | Recommended songs: ['Bounce Back', 'Bad and Boujee (feat. Lil Uzi Vert)', 'Congratulations', 'XO TOUR Llif3', 'HUMBLE.', 'Mask Off', 'T-Shirt', 'goosebumps']
2024-02-25 10:37:15,654 | DEBUG | Starting new HTTP connection (1): 10.109.19.3:52002
2024-02-25 10:37:15,656 | DEBUG | http://10.109.19.3:52002 "POST /api/recommend HTTP/1.1" 200 233
2024-02-25 10:37:15,657 | INFO | Response: <Response [200]>
2024-02-25 10:37:15,657 | INFO | Code version: 2.3
2024-02-25 10:37:15,657 | INFO | Model time: 2024-02-25 15:31:15.869998
2024-02-25 10:37:15,657 | INFO | Dataset: 2023_spotify_ds2.csv
2024-02-25 10:37:15,657 | INFO | Recommended songs: ['T-Shirt', 'goosebumps', 'HUMBLE.', 'XO TOUR Llif3', 'Bad and Boujee (feat. Lil Uzi Vert)', 'Mask Off', 'Bounce Back', 'Congratulations']
```

The upgrade process from container version 0.4 (code version 2.2) to 0.5 (code version 2.3) took approximately 0.6 seconds. During this transition, there were failed requests and responses that still carried the old version number.
